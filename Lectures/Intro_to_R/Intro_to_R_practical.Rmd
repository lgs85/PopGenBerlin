---
title: 'Introduction to R: practical'
author: "Lewis Spurgin"
date: "May 2017"
output: pdf_document
---

## Introduction
The aim of this practical is to get you comfortable using R and R studio. By the end of this practical, you ahould be able to read data into R, explore data frames, write a short program to perform some basic data processing, and plot and test some results. Somen general tips:

- Write all your commands in a SCRIPT and run them from there.
- Annotate your script well (using `#`). No amount of annotation is too much if it helps you understand what you're doing.
- Use R's help (e.g. `?mean`) if you are not sure what a function does
- Google is your friend

## The data
Scientists have taken blood samples from bearded finches captured from mainland and island populations. They have genotyped all the samples at a single micorsatellite locus, at which they found two alleles of 100bp an 102bp, respectively. They wish to know whether, at this locus, the mainland and island populations have different levels of genetic diversity.

## Instructions
Our aim is to calculate *observed heterozygosity* (i.e. the proportion of heterozygotes) in each of the populations in our dataset. We will plot these proportions, and test whether levels of heterozygosity differ between the two populations. 

*If you think you can do this without guidance, please go ahead and do so*. Otherwise, step-by-step instructions are provided below.

###Step 1. Set the working directory, read in and explore the data.

Set your working directory to the "Lectures/Intro_to_R" folder
```{r eval=FALSE}
setwd("path/PopGenBerlin/Lectures/Intro_to_R")
```

Now you can read in your data, and assign it to an object name. We will use the name `dd`.

```{r}
dd <- read.csv("Data/Microsat_data.csv")
```

We can explore our data by typing some functions into our script and running them. We will use the functions `head()` and `str()`.

```{r}
head(dd)
str(dd)
```

The function `head()` can be very useful when you want a quick look data frames with many rows. But `str()` gives us all the same information and more. From the output above, you should be able to answer the following:

- How many individuals are there in your dataset?
- How many populations are there?
- How has R stored the microsatellite allele data?
- How has it stored the Individual and Population ID data?

Before we go further, take a look at the help sheed for the `read.csv()` function, by typing `?read.csv` into the console. You will see that there are lots of options within this function - for now, scroll down the list of arguments and read the entry for `as.is`. Have a think and discuss with a neighbour what you think this means. Compare the following to what you ran previously. 

```{r}
dd <- read.csv("Data/Microsat_data.csv",as.is = T)
str(dd)
```

What is different here? What is the difference between a character and a factor? Note also the `$` symbols before each of the variable names. We can call up individual variable using this notation.

```{r}
dd$Pop
```

We can also use square bracket notation to call up individual rows and column. Using this notation, get R to print out:

- the 45th row
- the 2nd column
- the value of *Allele_1* for the 22nd individual

###Step two - define our genotypes
In our dataset we have separate information for each of the two alleles found in each individual. For example, we can see from when we ran the `head()` function that the first individual in our dataset has an allele of length `r dd$Allele_1[1]` for its first allele, and an allele of length `r dd$Allele_2[1]` for its second allele. This individual is therefore a `r ifelse(dd$Allele_1[1] == dd$Allele_2[1],"homozygote","heterozygote")` at this microsatellite locus. We can tell R to give use this information to tell us about heterozygosity. But first, we need to get an understanding of logical operators in R. Try typing the following commands directly into your terminal (I know we said not to do this, but it's ok here!):

```{r,eval = F}
4 < 3
4 > 3

4 = 3
4 == 3 #gives us an error. Why?

x = 4
x == 4

"cat" == "dog"

x <- "cat"
x == "cat"
```

Hopefully you have figures out that a single equals sign and double equals sign mean very different things to R. A single equals sign generally works in the same way as the `<-` operator (with a few subtle differences), whereas a double equals sign asks a logical question, and returns a value of `TRUE` or `FALSE`.

So coming back to our microsatellite data, we can use the `==` operator to ask whether an individual is a homozygote, by asking whether the variables `Allele_1` and `Allele_2` are the same.

```{r}
# Get the data for the first individual and have a look at it
ind1 <- dd[1,]
ind1

# Now ask whether Allele 1 and Allele 2 are identical
ind1$Allele_1 == ind1$Allele_2

```

Because R works so nicely with vectors, we can do this for every individual in our dataset, as follows:

```{r}

dd$Allele_1 == dd$Allele_2

```

This gives us `r nrow(dd)` `TRUE` or `FALSE` values, and tells us whether each individual in our dataset is a homozygote or not. Now all we need to do is turn this into a column of our data frame, indicating whether each individual is a homozygote or a heterozygote. We can do this using the `ifelse()` function. Check out what this function does using `?ifelse`

```{r}

#Add a Heterozygosity column
dd$Het <- ifelse(dd$Allele_1 == dd$Allele_2,"Homozygote","Heterozygote")

#Check that it's worked
head(dd)

```

We can see that the homozygotes and heterzygotes are being correctly identified. Now we can do some calculations and make a plot.

###Step three - calculate and plot genotype frequencies

Now we want to calculate the proportion of heterozygotes in each of our two populations. To do this, we need to know i) the number of heterozygotes in each population and ii) the total number of individuals in each population. We can get both of these pieces of information using the function `table()`.

```{r,fig.width = 4}
table(dd$Het) #Number of each genotype
table(dd$Pop) #Number of individuals in each population
table(dd$Het,dd$Pop) #Both combined

```

We can assign the output of the `table()` function to an object. Then using this we can extract subsets of tata and perform calculations using them. Using this approach, we can divide the number of heterozygotes by the sample size to calculate observed heterozygosity. 

```{r}
#Get the number of heterozygotes and the sample size for each population
het_counts <- table(dd$Het,dd$Pop)["Heterozygote",] #pulls out the heterozygote row
samplesizes <- table(dd$Pop) #Calculate sample sizes

#Now divide the two together
het_freqs <- het_counts/samplesizes
het_freqs
```

Now we can plot the frequencies. We will get into plotting in much more detail later in the course. For now, we will use the function `barplot()`.
```{r fig.width = 4}
barplot(het_freqs,ylab = "Proportion heterozygotes")
```

Finally, we can test whether the proportion of heterozygotes differs between mainland and island population using a Chi-squared test (`?chisq.test`).

```{r}
chisq.test(dd$Het,dd$Pop)
```

What are you able to conclude from this? Is the effect significant? Is it in the expected direction? What is lacking from this data?


## Finished? Some more challenging tasks

- Calculate and plot the frequency of the two alleles in each population.

- Calculate expected genotype frequencies for each population, according to Hardy-Weinberg. Compare your observed and expected frequencies using chi-squared tests.

- I simulated the microsatellite dataset for this practical in R. However, I did a dreadful job of annotating the script that I used to generate this dataset. Go through the script "Microsat_data.R", figure out what is being done with each line of code, and annotate the script accordingly.

- Simulate your own microsatellite dataset, either based on my approach, or by developing your own code.