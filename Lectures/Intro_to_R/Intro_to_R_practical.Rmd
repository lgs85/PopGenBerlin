---
title: 'Introduction to R: practical'
author: "Lewis Spurgin"
date: "May 2017"
output: pdf_document
---

## Introduction
The aim of this practical is to get you comfortable using R and R studio. By the end of this practical, you ahould be able to explore data frames, write a short program to perform some basic data processing, and plot and test some results. We will also have our first go at reading data into R. Some general tips:

- Write all your commands in a script and run them from there.
- Remove commands from your script that are not a useful part of your analysis
- Annotate your script well (using `#`). No amount of annotation is too much if it helps you understand what you're doing.
- Use R's help (e.g. `?mean`) if you are not sure what a function does
- Google is your friend

## The data
Scientists have taken blood samples from bearded finches captured from mainland and island populations. They have genotyped all the samples at a single micorsatellite locus, at which they found two alleles of 100bp an 102bp, respectively. They wish to know whether, at this locus, the mainland and island populations have different levels of genetic diversity.

## Instructions
Our aim is to calculate *observed heterozygosity* (i.e. the proportion of heterozygotes) in each of the populations in our dataset. We will plot these proportions, and test whether levels of heterozygosity differ between the two populations. 

*If you think you can do this without guidance, please go ahead and do so*. Otherwise, step-by-step instructions are provided below.

###Step 1. Set the working directory, read in and explore the data.

Open R studio. Either by typing in the console, or using the menu, set your working directory to the *Intro_to_R* folder. You will need to change the command below, depending on where the folder is stored on your computer. Also note how the command for changing the working directory in R differs to the corresponding command in bash and python.

```{r eval=FALSE}
getwd
setwd("path-to-your-folder/Intro_to_R")
```

Minimise R studio for a moment, and open up your file explorer. Find the *Intro_to_R/Data* folder for this lecture, and open the file *Microsat_data.csv*. You can open this in a spreadsheet editor (e.g. excel), or in your text editor. You should be able to see tht the data has four columns, and lots of rows. Each row is an individual. The columns correspond to individual ID, population ID, and the size (in bp) of the two alleles at the microsatellite locus. This is a standard way of storing microsatellite genotype data.

We are now going to data read this data into R using the function `read.csv()`, and assign it to an object name. We will use the name `dd`. Go back to R studio, and create a new R script. Save it using a sensible name in the *Intro_to_R* folder. At the top of your new R script, type the following:

```{r}
dd <- read.csv("../Data/Microsat_data.csv")
```

Make sure that you understand what this command is doing, including what is happening with the ".." part of the file path. Run the code, then click on the "environment" tab in the top-right pane of R studio. The object `dd` should now be listed. If so, the data has been successfully loaded into R. 

We can explore our data by typing some functions into our script and running them. We will use the functions `head()` and `str()`.

```{r}
head(dd)
str(dd)
```

The function `head()` can be very useful when you want a quick look data frames with many rows. But `str()` gives us all the same information and more. From the output above, you should be able to answer the following:

- How many individuals are there in your dataset?
- How many populations are there?
- How has R stored the microsatellite allele data?
- How has it stored the Individual and Population ID data?

Note also the `$` symbols before each of the variable names. We can call up individual variable using this notation.

```{r}
dd$Pop
```

We can also use square bracket notation to call up individual rows and column. Using this notation, get R to print out:

- the 45th row
- the 2nd column
- the value of *Allele_1* for the 22nd individual

###Step two - define our genotypes
In our dataset we have separate information for each of the two alleles found in each individual. For example, we can see from when we ran the `head()` function that the first individual in our dataset has an allele of length `r dd$Allele_1[1]` for its first allele, and an allele of length `r dd$Allele_2[1]` for its second allele. This individual is therefore a `r ifelse(dd$Allele_1[1] == dd$Allele_2[1],"homozygote","heterozygote")` at this microsatellite locus. We can tell R to give use this information to tell us about heterozygosity. But first, we need to get an understanding of logical operators in R. Try typing the following commands directly into your terminal (I know we said not to do this, but it's ok here!):

```{r,eval = F}
4 < 3
4 > 3

4 = 3
4 == 3 #gives us an error. Why?

x = 4
x == 4

"cat" == "dog"

x <- "cat"
x == "cat"
```

Hopefully you have figures out that a single equals sign and double equals sign mean very different things to R. A single equals sign generally works in the same way as the `<-` operator (with a few subtle differences), whereas a double equals sign asks a logical question, and returns a value of `TRUE` or `FALSE`.

So coming back to our microsatellite data, we can use the `==` operator to ask whether an individual is a homozygote, by asking whether the variables `Allele_1` and `Allele_2` are the same.

```{r}
# Get the data for the first individual and have a look at it
ind1 <- dd[1,]
ind1

# Now ask whether Allele 1 and Allele 2 are identical
ind1$Allele_1 == ind1$Allele_2

```

Because R works so nicely with vectors, we can do this for every individual in our dataset, as follows:

```{r}

dd$Allele_1 == dd$Allele_2

```

This gives us `r nrow(dd)` `TRUE` or `FALSE` values, and tells us whether each individual in our dataset is a homozygote or not. Now all we need to do is turn this into a column of our data frame, indicating whether each individual is a homozygote or a heterozygote. We can do this using the `ifelse()` function. Check out what this function does using `?ifelse`. Add the following to your R script.

```{r}

#Add a Heterozygosity column
dd$Het <- ifelse(dd$Allele_1 == dd$Allele_2,"Homozygote","Heterozygote")

#Check that it's worked
head(dd)

```

We can see that the homozygotes and heterzygotes are being correctly identified. Now we can do some calculations and make a plot.

###Step three - calculate and plot genotype frequencies

Now we want to calculate the proportion of heterozygotes in each of our two populations. To do this, we need to know i) the number of heterozygotes in each population and ii) the total number of individuals in each population. We can get both of these pieces of information using the function `table()`.

```{r,fig.width = 4}
table(dd$Het) #Number of each genotype
table(dd$Pop) #Number of individuals in each population
table(dd$Het,dd$Pop) #Both combined

```

We can assign the output of the `table()` function to an object. Then using this we can extract subsets of tata and perform calculations using them. Using this approach, we can divide the number of heterozygotes by the sample size to calculate observed heterozygosity. 

```{r}
#Get the number of heterozygotes and the sample size for each population
het_counts <- table(dd$Het,dd$Pop)["Heterozygote",] #pulls out the heterozygote row
samplesizes <- table(dd$Pop) #Calculate sample sizes

#Now divide the two together
het_freqs <- het_counts/samplesizes
het_freqs
```

Now we can plot the frequencies. We will get into plotting in much more detail later in the course. For now, we will use the function `barplot()`.
```{r fig.width = 4}
barplot(het_freqs,ylab = "Proportion heterozygotes")
```

Finally, we can test whether the proportion of heterozygotes differs between mainland and island population using a Chi-squared test (`?chisq.test`).

```{r}
chisq.test(dd$Het,dd$Pop)
```

What are you able to conclude from this? Is the effect significant? Is it in the expected direction? What is lacking from this data?

##Putting it all together
How does your script look? Can you figure out which commands you need to perform all the above analysis? Your script should end up looking something like the *Microsat_analysis.R* script including in the *Intro_to_R* folder. Note how we end up doing quite a lot with just five lines of code!

## Finished? Some more challenging tasks

- Calculate and plot the frequency of the two alleles in each population.

- Calculate expected genotype frequencies for each population, according to Hardy-Weinberg. Compare your observed and expected frequencies using chi-squared tests.

- I simulated the microsatellite dataset for this practical in R. However, I did a dreadful job of annotating the script that I used to generate this dataset. Go through the script "Microsat_data.R", figure out what is being done with each line of code, and annotate the script accordingly.

- Simulate your own microsatellite dataset, either based on my approach, or by developing your own code.